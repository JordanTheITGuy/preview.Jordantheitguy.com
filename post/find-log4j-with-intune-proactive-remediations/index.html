<!doctype html><html dir=ltr lang=en data-theme=dark><head>
<title>
Jordan Benzing
|
Find Log4J With Intune Proactive Remediations
</title>
<meta charset=utf-8><meta name=generator content="Hugo 0.92.1"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name=description content="
      How to find potentially risk files with LOG4J risks


    ">
<link rel=stylesheet href=/css/main.min.c71fbe942a9b51fb96cf0c76b7d4b4b72a909f75b07dae5f35db2c3617422468.css integrity="sha256-xx++lCqbUfuWzwx2t9S0tyqQn3Wwfa5fNdssNhdCJGg=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=/css/markupHighlight.min.058b31f17db60602cc415fd63b0427e7932fbf35c70d8e341a4c39385f5f6f3e.css integrity="sha256-BYsx8X22BgLMQV/WOwQn55MvvzXHDY40Gkw5OF9fbz4=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous>
<link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png>
<link rel=canonical href=http://preview.jordantheitguy.com/post/find-log4j-with-intune-proactive-remediations/>
<script type=text/javascript src=/js/anatole-header.min.2a2cd9614b7d007dfbb75e8da19e3a0fa872ceab53c6d000c00b7a0c89b85bfc.js integrity="sha256-KizZYUt9AH37t16NoZ46D6hyzqtTxtAAwAt6DIm4W/w=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/anatole-theme-switcher.min.7fd87181cdd7e8413aa64b6867bb32f3a8dc242e684fc7d5bbb9f600dbc2b6eb.js integrity="sha256-f9hxgc3X6EE6pktoZ7sy86jcJC5oT8fVu7n2ANvCtus=" crossorigin=anonymous></script>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Find Log4J With Intune Proactive Remediations">
<meta name=twitter:description content="How to find potentially risk files with LOG4J risks">
<script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"post","name":"Find Log4J With Intune Proactive Remediations","headline":"Find Log4J With Intune Proactive Remediations","alternativeHeadline":"","description":"
      How to find potentially risk files with LOG4J risks


    ","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/preview.jordantheitguy.com\/post\/find-log4j-with-intune-proactive-remediations\/"},"author":{"@type":"Person","name":"Jordan Benzing"},"creator":{"@type":"Person","name":"Jordan Benzing"},"accountablePerson":{"@type":"Person","name":"Jordan Benzing"},"copyrightHolder":{"@type":"Person","name":"Jordan Benzing"},"copyrightYear":"2021","dateCreated":"2021-12-17T00:00:00.00Z","datePublished":"2021-12-17T00:00:00.00Z","dateModified":"2021-12-17T00:00:00.00Z","publisher":{"@type":"Organization","name":"Jordan Benzing","url":"http://preview.jordantheitguy.com/","logo":{"@type":"ImageObject","url":"http:\/\/preview.jordantheitguy.com\/favicons\/favicon-32x32.png","width":"32","height":"32"}},"image":[],"url":"http:\/\/preview.jordantheitguy.com\/post\/find-log4j-with-intune-proactive-remediations\/","wordCount":"1686","genre":["Intune"],"keywords":["PowerShell"]}</script>
</head>
<body>
<header><div class="page-top
.">
<a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
</a>
<nav>
<ul class=nav__list id=navMenu>
<div class=nav__links>
<li>
<a href=/ title>Home</a>
</li>
<li>
<a href=/post/ title>Posts</a>
</li>
<li>
<a href=/about/ title>About</a>
</li>
</div>
<ul>
<li>
<a class=theme-switch title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a>
</li>
</ul>
</ul>
</nav>
</div>
</header>
<div class=wrapper>
<aside><div class="sidebar
.">
<div class=sidebar__content>
<div class=logo-title>
<div class=title>
<img src=/images/JordanTheITGuy.png alt="profile picture">
<h3 title><a href=/>I'm JordanTheITGuy</a></h3>
<div class=description>
<p>I currently work as an Engineer at Patch My PC.<br></p>
</div>
</div>
</div>
<ul class=social-links>
<li>
<a href=https://twitter.com/JordanTheITguy rel=me aria-label=Twitter title=Twitter>
<i class="fab fa-twitter fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=https://github.com/JordanTheITGuy rel=me aria-label=Github title=Github>
<i class="fab fa-github fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=https://www.youtube.com/c/JordanTheItGuy rel=me aria-label=Youtube title=Youtube>
<i class="fab fa-youtube fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=https://www.linkedin.com/in/jordan-benzing-432b0619/ rel=me aria-label=Linkedin title=Linkedin>
<i class="fab fa-linkedin fa-2x" aria-hidden=true></i>
</a>
</li>
</ul>
</div><footer class="footer footer--sidebar">
<div class=by_farbox>
<ul class=footer__list>
<li class=footer__item>
&copy;
Jordan Benzing
2022
</li>
</ul>
</div>
</footer>
<script type=text/javascript src=/js/medium-zoom.min.71100d84fab0ad794b8399a66ac810700cc78d703f715dc10af4d7ba7b761362.js integrity="sha256-cRANhPqwrXlLg5mmasgQcAzHjXA/cV3BCvTXunt2E2I=" crossorigin=anonymous></script></div>
</aside>
<main>
<div class=autopagerize_page_element>
<div class=content>
<div class="post
.">
<div class=post-content>
<img class=post-thumbnail src=/images/blogPosts/MakeScriptPackage.png alt="Thumbnail image">
<div class=post-title>
<h1>Find Log4J With Intune Proactive Remediations</h1>
<div class=info>
<em class="fas fa-calendar-day"></em>
<span class=date>
Fri, Dec 17, 2021
</span>
<em class="fas fa-stopwatch"></em>
<span class=reading-time>8-minute read</span>
</div>
</div><p>On December 10th 2021 CVE-2021-44228 was unveiled- queue the mass panic. A simple logging component which had been around for… forever in a whole bunch of things including but not limited to Minecraft.</p>
<p>Update: February 6th 2022 - It&rsquo;s worth nothing that even now three months later this vulnerability is still having massive impact all over the world as the threat hunting methods originally devised were limited in their nature. In fact, we have even seen cases where grey hat hackers were using the exploit to patch the exploit.</p>
<h2 id=vulnerability-hunting-vs-exploit-hunting>Vulnerability Hunting V.S. Exploit Hunting</h2>
<style type=text/css>.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:#444;background:#e7f2fa}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:#fff;background:#6ab0de}.notice.warning .notice-title{background:rgba(217,83,79,.9)}.notice.warning{background:#fae2e2}.notice.info .notice-title{background:#f0b37e}.notice.info{background:#fff2db}.notice.note .notice-title{background:#6ab0de}.notice.note{background:#e7f2fa}.notice.tip .notice-title{background:rgba(92,184,92,.8)}.notice.tip{background:#e6f9e6}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style>
<div><svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg"><symbol id="tip-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379.0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628.0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628.0l-22.627 22.627c-6.248 6.248-6.248 16.379.0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/></symbol><symbol id="note-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="warning-notice" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet"><path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937.0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154.0l239.94 416.028zM288 354c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="info-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"/></symbol></svg></div><div class="notice warning">
<p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#warning-notice"/></svg></span>Warning</p><p><strong>Before you read any further, let me be clear, finding a “file” that has or is vulnerable to this exploit this is not the end of dealing with this vulnerability. I have tried to cover all the scenarios I can think of, however I am not a genius and there is no way to write this for every possible scenario. It’s one half of the whole. You absolutely need to start continuously hunting for the behaviors attackers would use this class for, while constantly checking for the existence of it in your environment.</strong></p></div>
<p>Hunting this threat is in and of itself challenging.</p>
<p>When the vulnerability first came out there were several scripts that floated around the internet geared towards hunting the hashes of the vulnerable files. However as things continued to develop people started to ask – do these hashes change if someone nests a JAR inside a JAR? Additionally, what if an attacker changes the name of the product or the class is referenced in another JAR? And how do we tell the difference between something that is just not updated, and something being exploited? For more reading on that I suggest the following MSTIC team articles:</p>
<p><a href=https://techcommunity.microsoft.com/t5/microsoft-defender-for-cloud/how-defender-for-cloud-displays-machines-affected-by-log4j/ba-p/3037271>Defender for Cloud finds machines affected by Log4j vulnerabilities</a></p>
<p><a href=https://msrc-blog.microsoft.com/2021/12/11/microsofts-response-to-cve-2021-44228-apache-log4j2/>Microsoft’s Response to CVE-2021-44228 Apache Log4j 2 – Microsoft Security Response Center</a></p>
<h2 id=what-can-you-do-today-with-intune-proactive-remediations>What can you do today with Intune Proactive Remediations?</h2>
<p><img src=/images/blogPosts/MakeScriptPackage.png alt=Example></p>
<p>In Configuration Manager we have CI’s and they work amazingly well for hunting the state, and contents of specific files.</p>
<p>I’m going to put a second disclaimer here, don’t use this script as an end all to everything. There is no one size fits all for this vulnerability, and in fact just saying “we patched all good” might not even be good enough for a while. Since last week, I’ve written three or four different methods to try and detect “do we need to patch this vulnerability.” All three of these methods have different pros’s and cons based on number of files, age of device, and are you looking for obfuscations. In general people have landed on three main different methods.</p>
<ul>
<li>Hash Validation, based on file name</li>
<li>File Name Detection</li>
<li>File Extension Detection and Class Validation</li>
</ul>
<p>The script I’m going to show uses the last of these three options. All of these have their own unique pro’s and con’s. I could spend hours on these, but I don’t think that’s why you’re here if this is something you’re interested in let me know and maybe I’ll do some type of follow up.</p>
<p>If you’ve never created a Proactive Remediation before, rejoice because the most complicated part of creating one, is finding where they are located.</p>
<h2 id=the-script-for-the-proactive-remediation>The Script for the Proactive Remediation</h2>
<p>This article assumes you know how to create a proactive remediation, and will only be covering an explanation on the script used for detection.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 0</span><span style=color:#6272a4>#Warning on potentially could scan synced sharepoint libraries.</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#6272a4>#Note this is using CIM instance - this will NOT work for old Servers and is not intended to be used on them.</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span style=color:#8be9fd;font-style:italic>$drives</span> = (<span style=color:#8be9fd;font-style:italic>Get-CimInstance</span> -Query <span style=color:#f1fa8c>&#34;Select DeviceID from win32_logicaldisk where drivetype = 3&#34;</span>).DeviceID
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span style=color:#6272a4>#Set the search string we are hunting for.</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span style=color:#8be9fd;font-style:italic>$searchString</span> = <span style=color:#f1fa8c>&#34;*.jar&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span style=color:#6272a4>#Add type for reading the JarFiles </span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span style=color:#8be9fd;font-style:italic>Add-Type</span> -AssemblyName <span style=color:#f1fa8c>&#34;system.io.compression.filesystem&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span style=color:#6272a4>#Create an object to store found risks</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span style=color:#8be9fd;font-style:italic>$foundRisks</span> = <span style=color:#8be9fd;font-style:italic>New-Object</span> -TypeName <span style=color:#f1fa8c>&#39;System.Collections.Generic.List[psobject]&#39;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span style=color:#ff79c6>Foreach</span> (<span style=color:#8be9fd;font-style:italic>$drive</span> <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>$drives</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>    <span style=color:#6272a4>#Assemble the risky files for the drive.</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>    <span style=color:#8be9fd;font-style:italic>$riskyFiles</span> = (&amp;cmd /c robocopy /l $((<span style=color:#8be9fd;font-style:italic>$drive</span>) + <span style=color:#f1fa8c>&#39;\&#39;</span>) null <span style=color:#f1fa8c>&#34;$searchString&#34;</span> /ns /njh /njs /np /nc /ndl /xjd /mt /s).trim() | <span style=color:#8be9fd;font-style:italic>Where-Object</span> { <span style=color:#8be9fd;font-style:italic>$_</span> <span style=color:#ff79c6>-ne</span> <span style=color:#f1fa8c>&#34;&#34;</span> }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>    <span style=color:#6272a4>#Evaluate each set of risky files to see if there is anything to Evaluate.</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span>    <span style=color:#ff79c6>Foreach</span> (<span style=color:#8be9fd;font-style:italic>$file</span> <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>$riskyFiles</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span>                <span style=color:#8be9fd;font-style:italic>$data</span> = <span style=color:#8be9fd;font-style:italic>$null</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span>                <span style=color:#8be9fd;font-style:italic>$detections</span> = <span style=color:#8be9fd;font-style:italic>$null</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span>                <span style=color:#ff79c6>try</span>{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span>                    <span style=color:#6272a4>#Warning this could could potentially create a lock on a Jar file - we do dispose of the connection and read at the end but based on size it could take a moment.</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span>                    <span style=color:#8be9fd;font-style:italic>$data</span> = [io.Compression.Zipfile]::openRead(<span style=color:#8be9fd;font-style:italic>$file</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span>                    <span style=color:#8be9fd;font-style:italic>$detections</span> = <span style=color:#8be9fd;font-style:italic>$data</span>.Entries | <span style=color:#8be9fd;font-style:italic>Where-Object</span> {<span style=color:#8be9fd;font-style:italic>$_</span>.fullname <span style=color:#ff79c6>-like</span> <span style=color:#f1fa8c>&#34;*jndiLookup.class&#34;</span>}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span>                    <span style=color:#8be9fd;font-style:italic>$data</span>.Dispose()
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span>                }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span>                <span style=color:#ff79c6>catch</span>{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span>                    <span style=color:#8be9fd;font-style:italic>$hash</span> = [ordered]@{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span>                        fileName = <span style=color:#8be9fd;font-style:italic>$file</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span>                        class = <span style=color:#f1fa8c>&#34;UnableToRead&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span>                        fileHash = $((<span style=color:#8be9fd;font-style:italic>Get-FileHash</span> -Path <span style=color:#8be9fd;font-style:italic>$file</span> -Algorithm SHA256).Hash)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span>                    }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span>                    <span style=color:#8be9fd;font-style:italic>$foundRisks</span>.add((<span style=color:#8be9fd;font-style:italic>New-Object</span> -TypeName psobject -Property <span style=color:#8be9fd;font-style:italic>$hash</span>))
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span>                }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span>                <span style=color:#ff79c6>if</span>(<span style=color:#8be9fd;font-style:italic>$detections</span>){ 
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span>                    <span style=color:#ff79c6>foreach</span>(<span style=color:#8be9fd;font-style:italic>$detection</span> <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>$detections</span> ){
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span>                        <span style=color:#8be9fd;font-style:italic>$hash</span> = [ordered]@{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span>                            fileName = <span style=color:#8be9fd;font-style:italic>$file</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span>                            class = <span style=color:#8be9fd;font-style:italic>$detection</span>.FullName
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span>                            fileHash = $((<span style=color:#8be9fd;font-style:italic>Get-FileHash</span> -Path <span style=color:#8be9fd;font-style:italic>$file</span> -Algorithm SHA256).Hash)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span>                        }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span>                        <span style=color:#8be9fd;font-style:italic>$foundRisks</span>.add((<span style=color:#8be9fd;font-style:italic>New-Object</span> -TypeName psobject -Property <span style=color:#8be9fd;font-style:italic>$hash</span>))
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span>                    }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span>                }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span>            }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span>            
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span>        }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span style=color:#ff79c6>If</span> ($(<span style=color:#8be9fd;font-style:italic>$foundRisks</span> | <span style=color:#8be9fd;font-style:italic>Measure-Object</span>).count <span style=color:#ff79c6>-ge</span> 1) { 
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span>    <span style=color:#ff79c6>foreach</span>(<span style=color:#8be9fd;font-style:italic>$risk</span> <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>$foundRisks</span>){
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span>        <span style=color:#6272a4>#Assemble a Single Large Write Host Command for PR</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span>        <span style=color:#8be9fd;font-style:italic>$jumboTune</span> = <span style=color:#f1fa8c>&#34;$jumboTune Found: </span>$(<span style=color:#8be9fd;font-style:italic>$risk</span>.FileName)<span style=color:#f1fa8c> with Hash:</span>$(<span style=color:#8be9fd;font-style:italic>$risk</span>.fileHash)<span style=color:#f1fa8c> and Class: </span>$(<span style=color:#8be9fd;font-style:italic>$risk</span>.class)<span style=color:#f1fa8c>`n</span><span style=color:#f1fa8c>&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span>    }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span>    <span style=color:#8be9fd;font-style:italic>Write-Host</span> <span style=color:#8be9fd;font-style:italic>$jumboTune</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span>    exit 1
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span>}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span style=color:#ff79c6>Else</span> { 
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span>    <span style=color:#8be9fd;font-style:italic>Write-Host</span> <span style=color:#f1fa8c>&#34;No Vulnerabilities found&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span>    exit 0
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span>}
</code></pre></div><p>What’s so special about this script? Well, it’s fast. No seriously it’s REALLY fast. We are talking evaluate every file in 600GB in ~19 seconds fast. Most of this is thanks to Robocopy.</p>
<p>Now let’s break down the code and what’s happening here.</p>
<h4 id=initial-gathering-of-drives>Initial Gathering of Drives</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">0</span><span style=color:#6272a4>#Note this is using CIM instance - this will NOT work for old Servers and is not intended to be used on them.</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#8be9fd;font-style:italic>$drives</span> = (<span style=color:#8be9fd;font-style:italic>Get-CimInstance</span> -Query <span style=color:#f1fa8c>&#34;Select DeviceID from win32_logicaldisk where drivetype = 3&#34;</span>).DeviceID
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span style=color:#6272a4>#Set the search string we are hunting for.</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span style=color:#8be9fd;font-style:italic>$searchString</span> = <span style=color:#f1fa8c>&#34;*.jar&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span style=color:#6272a4>#Add type for reading the JarFiles </span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span style=color:#8be9fd;font-style:italic>Add-Type</span> -AssemblyName <span style=color:#f1fa8c>&#34;system.io.compression.filesystem&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span style=color:#6272a4>#Create an object to store found risks</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span style=color:#8be9fd;font-style:italic>$foundRisks</span> = <span style=color:#8be9fd;font-style:italic>New-Object</span> -TypeName <span style=color:#f1fa8c>&#39;System.Collections.Generic.List[psobject]&#39;</span>
</code></pre></div><p>Nothing fancy here, just know that this is using CIM instance, assuming you’re using this script in Intune, you should only have machines that support this command. Additionally we set our search string – in this case anything that ends with “*.jar”. We add a type assemble – more on that later, and then create a list of PSObjects. Didn’t have to do that, but I like to use lists it’s a habit from when I’m not sure what version of PowerShell is in play.</p>
<p>We then iterate over each drive and do the following:</p>
<h4 id=gather-risky-files>Gather Risky Files</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 0</span><span style=color:#8be9fd;font-style:italic>$riskyFiles</span> = (&amp;cmd /c robocopy /l $((<span style=color:#8be9fd;font-style:italic>$drive</span>) + <span style=color:#f1fa8c>&#39;\&#39;</span>) null <span style=color:#f1fa8c>&#34;$searchString&#34;</span> /ns /njh /njs /np /nc /ndl /xjd /mt /s).trim() | <span style=color:#8be9fd;font-style:italic>Where-Object</span> { <span style=color:#8be9fd;font-style:italic>$_</span> <span style=color:#ff79c6>-ne</span> <span style=color:#f1fa8c>&#34;&#34;</span> }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>    <span style=color:#6272a4>#Evaluate each set of risky files to see if there is anything to Evaluate.</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>    <span style=color:#ff79c6>Foreach</span> (<span style=color:#8be9fd;font-style:italic>$file</span> <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>$riskyFiles</span>) {
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>                <span style=color:#8be9fd;font-style:italic>$data</span> = <span style=color:#8be9fd;font-style:italic>$null</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>                <span style=color:#8be9fd;font-style:italic>$detections</span> = <span style=color:#8be9fd;font-style:italic>$null</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>                <span style=color:#ff79c6>try</span>{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>                    <span style=color:#6272a4>#Warning this could could potentially create a lock on a Jar file - we do dispose of the connection and read at the end but based on size it could take a moment.</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>                    <span style=color:#8be9fd;font-style:italic>$data</span> = [io.Compression.Zipfile]::openRead(<span style=color:#8be9fd;font-style:italic>$file</span>)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>                    <span style=color:#8be9fd;font-style:italic>$detections</span> = <span style=color:#8be9fd;font-style:italic>$data</span>.Entries | <span style=color:#8be9fd;font-style:italic>Where-Object</span> {<span style=color:#8be9fd;font-style:italic>$_</span>.fullname <span style=color:#ff79c6>-like</span> <span style=color:#f1fa8c>&#34;*jndiLookup.class&#34;</span>}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>                    <span style=color:#8be9fd;font-style:italic>$data</span>.Dispose()
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>                }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>                <span style=color:#ff79c6>catch</span>{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>                    <span style=color:#8be9fd;font-style:italic>$hash</span> = [ordered]@{
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>                        fileName = <span style=color:#8be9fd;font-style:italic>$file</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>                        class = <span style=color:#f1fa8c>&#34;UnableToRead&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>                        fileHash = $((<span style=color:#8be9fd;font-style:italic>Get-FileHash</span> -Path <span style=color:#8be9fd;font-style:italic>$file</span> -Algorithm SHA256).Hash)
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>                    }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>                    <span style=color:#8be9fd;font-style:italic>$foundRisks</span>.add((<span style=color:#8be9fd;font-style:italic>New-Object</span> -TypeName psobject -Property <span style=color:#8be9fd;font-style:italic>$hash</span>))
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span>                }
</code></pre></div><p>The first line leverages Robocopy, to gather only the string to file names using the /l command and some other switches to turn off the noise and speed ups the process of gathering the files. This then provides a list full of files with “*.Jar” at the end.</p>
<p>Now it’s time to go to work. We use the IO.Compression.ZipFile class to open and read the contents of each of the .JAR file. We then look at all of the “entries” for anything that has the jndiLookup.class.</p>
<p>We look for this, because if we find the class, we can be reasonable sure regardless of if there is a hash match, or if the file names don’t match that the machine is potentially at risk.</p>
<p>We then add some important bits like where the file is located and it’s hash to our storage and continue on.</p>
<p>We could just as easily swap this out for any of the other methods, validating if the .jar matches the known hash lists, or just reporting based on the name of the jar.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 0</span><span style=color:#ff79c6>If</span> ($(<span style=color:#8be9fd;font-style:italic>$foundRisks</span> | <span style=color:#8be9fd;font-style:italic>Measure-Object</span>).count <span style=color:#ff79c6>-ge</span> 1) { 
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>    <span style=color:#ff79c6>foreach</span>(<span style=color:#8be9fd;font-style:italic>$risk</span> <span style=color:#ff79c6>in</span> <span style=color:#8be9fd;font-style:italic>$foundRisks</span>){
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>        <span style=color:#6272a4>#Assemble a Single Large Write Host Command for PR</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>        <span style=color:#8be9fd;font-style:italic>$jumboTune</span> = <span style=color:#f1fa8c>&#34;$jumboTune Found: </span>$(<span style=color:#8be9fd;font-style:italic>$risk</span>.FileName)<span style=color:#f1fa8c> with Hash:</span>$(<span style=color:#8be9fd;font-style:italic>$risk</span>.fileHash)<span style=color:#f1fa8c> and Class: </span>$(<span style=color:#8be9fd;font-style:italic>$risk</span>.class)<span style=color:#f1fa8c>`n</span><span style=color:#f1fa8c>&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>    }
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>    <span style=color:#8be9fd;font-style:italic>Write-Host</span> <span style=color:#8be9fd;font-style:italic>$jumboTune</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>    exit 1
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span style=color:#ff79c6>Else</span> { 
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>    <span style=color:#8be9fd;font-style:italic>Write-Host</span> <span style=color:#f1fa8c>&#34;No Vulnerabilities found&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>    exit 0
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>}
</code></pre></div><p>Finally here at the end we compound together the names of the potentially vulnerable files, and write them to the host screen before existing with Exit Code 1 to properly send “risk” back to Intune.</p>
<p>Once the script runs based you should get some nice outputs which you can then use to evaluate and start to make decisions on what should or shouldn’t be remediated. Keep in mind this doesn’t fix the issue as fixes will continue to evolve. This just helps you identify the problem. Here is an example of what the output looks like on my home machines, which happened to have an old copy of Minecraft on it.</p>
<p><img src=/images/blogPosts/log4JFound.png alt=img></p>
<h3 id=closing-thoughts>Closing Thoughts</h3>
<p>I urge you to keep in mind that this is an evolving threat. The first “patch” to remediate the CVE was found to not always work. The second one encouraged people to just flat out remove the jndi lookup.class from the class path. I wouldn’t be surprised if we find several more things along the way. Your mileage may vary on how you look for vulnerability and I encourage you to think about what you are hunting for. Happy Patching.</p>
</div>
<div class=post-footer>
<div class=info>
<span class=separator><a class=category href=/categories/intune/>Intune</a></span>
<span class=separator><a class=tag href=/tags/powershell/>PowerShell</a></span>
</div>
</div>
<div id=fb_comments_container>
<h2>comments</h2>
<script src=https://utteranc.es/client.js repo=JordanTheITGuy/jordantheitguy.com-comments issue-term=title theme=preferred-color-scheme crossorigin=anonymous async></script>
</div>
</div>
</div>
</div>
</main>
</div><footer class="footer footer--base">
<div class=by_farbox>
<ul class=footer__list>
<li class=footer__item>
&copy;
Jordan Benzing
2022
</li>
</ul>
</div>
</footer>
<script type=text/javascript src=/js/medium-zoom.min.71100d84fab0ad794b8399a66ac810700cc78d703f715dc10af4d7ba7b761362.js integrity="sha256-cRANhPqwrXlLg5mmasgQcAzHjXA/cV3BCvTXunt2E2I=" crossorigin=anonymous></script></body>
</html>